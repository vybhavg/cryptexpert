{% extends "base.html" %}

{% block title %}Wallet Management{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg p-4">
        <h2 class="text-center">Wallet Management</h2>

        <!-- API Key Submission Form -->
        <div class="mb-5">
            <h4>Submit API Key</h4>
            <form method="POST" action="{{ url_for('wallet_management') }}">
                <input type="hidden" name="api_key" value="true">
                <div class="mb-3">
                    <label for="exchange" class="form-label">Exchange</label>
                    <select class="form-select" id="exchange" name="exchange" required>
                        <option value="">Select Exchange</option>
                        {% for exchange in ["Binance", "Coinbase", "CoinMarketCap"] %}
                            <option value="{{ exchange }}" {% if exchange in user_exchanges %}selected{% endif %}>
                                {{ exchange }}
                                {% if exchange in user_exchanges %}
                                    ✅
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="api_key" class="form-label">API Key</label>
                    <input type="text" class="form-control" id="api_key" name="api_key" required>
                </div>
                <div class="mb-3">
                    <label for="api_secret" class="form-label">API Secret</label>
                    <input type="text" class="form-control" id="api_secret" name="api_secret" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Submit API Key</button>
            </form>
        </div>

        <!-- API Key List with Delete Option -->
        <div class="mb-5">
            <h4>Your API Keys</h4>
            {% for api in user_api_keys %}
                <div class="d-flex justify-content-between align-items-center p-2 border rounded bg-white mt-2">
                    <span><strong>{{ api.exchange }}</strong> ✅</span>
                    <form method="POST" action="{{ url_for('delete_api_key', api_id=api.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                    </form>
                </div>
            {% endfor %}
        </div>

        <!-- Fetch Wallet Balances Form -->
        <div class="mb-5">
            <h4>Fetch Wallet Balances</h4>
            <form method="POST" action="{{ url_for('wallet_management') }}">
                <div class="mb-3">
                    <label for="exchange" class="form-label">Select Exchange</label>
                    <select class="form-select" id="exchange" name="exchange" required>
                        <option value="">Select Exchange</option>
                        {% for exchange in ["Binance", "Coinbase", "CoinMarketCap"] %}
                            <option value="{{ exchange }}" {% if exchange == selected_exchange %}selected{% endif %}>
                                {{ exchange }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-100">Fetch Balances</button>
            </form>
        </div>

        <!-- Display Wallet Balances -->
        {% if balances %}
            <h3 class="mt-4">Balances for {{ exchange }}</h3>
            {% if total_balance_usd %}
                <h3 class="mt-4">Total Balance: {{ total_balance_usd }}</h3>
            {% endif %}
            <table class="table table-bordered mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>Coin</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for coin, amount in balances.items() %}
                        <tr>
                            <td>{{ coin }}</td>
                            <td>{{ amount }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif exchange %}
            <p class="mt-3 text-danger">No balances found or API keys missing.</p>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
