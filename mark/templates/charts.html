{% extends "base.html" %}

{% block title %}CryptExpert - Charts{% endblock %}

{% block head %}
    <!-- Additional head content specific to charts.html -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
{% endblock %}

{% block content %}
  <div class="flex flex-row gap-4">
    <!-- Sell Orders (Left Side) -->
    <div class="w-1/6 p-4 rounded-lg">
        <h3 class="text-lg font-bold text-white mb-4">Sell Orders</h3>
        <div class="text-gray-400 text-sm flex justify-between mb-2">
            <span>Price (USDT)</span>
            <span>Amount (BTC)</span>
            <span>Total</span>
        </div>
        <div id="sell-orders" class="space-y-2">
            <!-- Sell orders will be dynamically populated here -->
        </div>
    </div>

    <!-- TradingView Chart (Middle) -->
    <div class="w-2/3">
        <h2 id="crypto-title" class="text-white text-xl font-bold mb-4"></h2>
        <div id="tradingview_chart" style="height: 500px;"></div>
    </div>

    <!-- Buy Orders (Right Side) -->
    <div class="w-1/6 p-4 rounded-lg">
        <h3 class="text-lg font-bold text-white mb-4">Buy Orders</h3>
        <div class="text-gray-400 text-sm flex justify-between mb-2">
            <span>Price (USDT)</span>
            <span>Amount (BTC)</span>
            <span>Total</span>
        </div>
        <div id="buy-orders" class="space-y-2">
            <!-- Buy orders will be dynamically populated here -->
        </div>
    </div>
</div>

    <script type="text/javascript">
document.addEventListener("DOMContentLoaded", function () {
    // Initialize WebSocket
    const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@depth');

    ws.onopen = () => {
        console.log('WebSocket connection established');
    };

    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
    };

    ws.onclose = () => {
        console.log('WebSocket connection closed');
    };

ws.onmessage = (event) => {
    try {
        const data = JSON.parse(event.data);

        // Check if the message is a depthUpdate
        if (data.e === 'depthUpdate') {
            const { b: bids, a: asks } = data;

            // Function to format numbers with thousands separators
            const formatNumber = (num) => {
                return num.toLocaleString(undefined, { maximumFractionDigits: 8 });
            };

            // Display Sell Orders (Asks)
            const sellOrders = document.getElementById("sell-orders");
            sellOrders.innerHTML = asks.slice(0, 10) // Limit to 10 orders
                .map(order => {
                    const price = parseFloat(order[0]);
                    const amount = parseFloat(order[1]);
                    const total = price * amount;
                    return `
                        <div class="text-red-500 text-sm flex justify-between">
                            <span>${formatNumber(price)}</span>
                            <span>${formatNumber(amount)}</span>
                            <span>${formatNumber(total)}</span>
                        </div>
                    `;
                })
                .join("");

            // Display Buy Orders (Bids)
            const buyOrders = document.getElementById("buy-orders");
            buyOrders.innerHTML = bids.slice(0, 10) // Limit to 10 orders
                .map(order => {
                    const price = parseFloat(order[0]);
                    const amount = parseFloat(order[1]);
                    const total = price * amount;
                    return `
                        <div class="text-green-500 text-sm flex justify-between">
                            <span>${formatNumber(price)}</span>
                            <span>${formatNumber(amount)}</span>
                            <span>${formatNumber(total)}</span>
                        </div>
                    `;
                })
                .join("");
        } else {
            console.error("Unexpected WebSocket data format:", data);
        }
    } catch (error) {
        console.error("Error processing WebSocket message:", error);
    }
};

    // Load TradingView chart
    if (typeof TradingView === "undefined") {
        console.error("TradingView library failed to load. Retrying...");
        setTimeout(() => {
            if (typeof TradingView !== "undefined") {
                loadTradingViewChart();
            } else {
                console.error("TradingView library still not available.");
            }
        }, 2000);
    } else {
        loadTradingViewChart();
    }

    function loadTradingViewChart() {
        const urlParams = new URLSearchParams(window.location.search);
        const symbol = urlParams.get("symbol") || "BTC";
        document.getElementById("crypto-title").textContent = `${symbol} Chart`;

        new TradingView.widget({
            "container_id": "tradingview_chart",
            "symbol": `BINANCE:${symbol}USDT`,
            "interval": "D",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "autosize": true
        });
    }
});
    </script>
{% endblock %}
{% block style %}
    <!-- Additional styles specific to charts.html -->
    <style>
        /* General Styles */
        body {
            background-color: #121212; /* Dark background for the entire page */
            color: #ffffff; /* White text for better contrast */
            font-family: 'Inter', sans-serif; /* Modern font */
        }

        /* Flex Container */
        .flex {
            display: flex;
            margin-top: 75px;
            gap: 1rem;
        }

        /* Box Styles */
        .bg-gray-800 {
            background-color: #1e1e1e; /* Blackish-grey background */
            border: 1px solid #333; /* Subtle border */
            border-radius: 10px; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Soft shadow for depth */
        }

        .p-4 {
            padding: 1.5rem; /* Increased padding for better spacing */
        }

        /* Text Styles */
        .text-white {
            color: #ffffff;
        }

        .text-red-500 {
            color: #ef4444; /* Red for sell orders */
        }

        .text-green-500 {
            color: #22c55e; /* Green for buy orders */
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-semibold {
            font-weight: 600;
        }

        .mb-4 {
            margin-bottom: 1.5rem; /* Increased margin for better spacing */
        }

        /* Order Book Styles */
        #sell-orders, #buy-orders {
            max-height: 500px; /* Limit height for scrollability */
            overflow-y: auto; /* Add scrollbar if content overflows */
        }

        #sell-orders div, #buy-orders div {
            padding: 0.5rem 0; /* Add padding to each order row */
            border-bottom: 1px solid #333; /* Subtle separator between rows */
        }

        #sell-orders div:last-child, #buy-orders div:last-child {
            border-bottom: none; /* Remove border for the last row */
        }

        /* TradingView Chart Styles */
        #tradingview_chart {
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Soft shadow for depth */
        }

        /* Header Styles */
        h3 {
            font-size: 1.25rem; /* Larger font size for headers */
            margin-bottom: 1.5rem; /* Increased margin for better spacing */
        }

        h2 {
            font-size: 1.5rem; /* Larger font size for the chart title */
            margin-bottom: 1.5rem; /* Increased margin for better spacing */
        }

        /* Scrollbar Styles (for order books) */
        ::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e; /* Track color */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #333; /* Thumb color */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444; /* Thumb color on hover */
        }
    </style>
{% endblock %}
