{% extends "base.html" %}

{% block title %}CryptExpert - Charts{% endblock %}

{% block head %}
    <!-- Additional head content specific to charts.html -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
{% endblock %}

{% block content %}
    <div class="flex flex-row gap-4">
        <!-- Sell Orders (Left Side) -->
        <div class="w-1/6 bg-gray-800 p-4 rounded-lg">
            <h3 class="text-lg font-bold text-white mb-4">Sell Orders</h3>
            <div id="sell-orders" class="space-y-2">
                <!-- Sell orders will be dynamically populated here -->
            </div>
        </div>

        <!-- TradingView Chart (Middle) -->
        <div class="w-2/3">
            <h2 id="crypto-title" class="text-white text-xl font-bold mb-4"></h2>
            <div id="tradingview_chart" style="height: 500px;"></div>
        </div>

        <!-- Buy Orders (Right Side) -->
        <div class="w-1/6 bg-gray-800 p-4 rounded-lg">
            <h3 class="text-lg font-bold text-white mb-4">Buy Orders</h3>
            <div id="buy-orders" class="space-y-2">
                <!-- Buy orders will be dynamically populated here -->
            </div>
        </div>
    </div>

   <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof TradingView === "undefined") {
            console.error("TradingView library failed to load. Retrying...");
            setTimeout(() => {
                if (typeof TradingView !== "undefined") {
                    loadTradingViewChart();
                } else {
                    console.error("TradingView library still not available.");
                }
            }, 2000);
        } else {
            loadTradingViewChart();
        }

        function loadTradingViewChart() {
            const urlParams = new URLSearchParams(window.location.search);
            const symbol = urlParams.get("symbol") || "BTC";
            document.getElementById("crypto-title").textContent = `${symbol} Chart`;

            new TradingView.widget({
                "container_id": "tradingview_chart",
                "symbol": `BINANCE:${symbol}USDT`,
                "interval": "D",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "autosize": true
            });
        }
    });

       ws.onmessage = (event) => {
    try {
        const data = JSON.parse(event.data);

        if (!data.bids || !data.asks) {
            console.error("Unexpected WebSocket data format:", data);
            return;
        }

        const { bids, asks } = data;

        // Display Sell Orders (Asks)
        const sellOrders = document.getElementById("sell-orders");
        sellOrders.innerHTML = asks.slice(0, 10) // Limit to 10 orders
            .map(order => `
                <div class="text-red-500 text-sm flex justify-between">
                    <span>${parseFloat(order[0]).toFixed(4)}</span>
                    <span>${parseFloat(order[1]).toFixed(4)}</span>
                </div>
            `)
            .join("");

        // Display Buy Orders (Bids)
        const buyOrders = document.getElementById("buy-orders");
        buyOrders.innerHTML = bids.slice(0, 10) // Limit to 10 orders
            .map(order => `
                <div class="text-green-500 text-sm flex justify-between">
                    <span>${parseFloat(order[0]).toFixed(4)}</span>
                    <span>${parseFloat(order[1]).toFixed(4)}</span>
                </div>
            `)
            .join("");

    } catch (error) {
        console.error("Error processing WebSocket message:", error);
    }
};

</script>

{% endblock %}

{% block style %}
    <!-- Additional styles specific to charts.html -->
    <style>
        #tradingview_chart {
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        .flex {
            display: flex;
            margin-top:75px;
        }

        .flex-row {
            flex-direction: row;
        }

        .gap-4 {
            gap: 1rem;
        }

        .w-1\/6 {
            width: 16.666667%;
        }

        .w-2\/3 {
            width: 66.666667%;
        }

        .bg-gray-800 {
            background-color: #2d3748;
        }

        .p-4 {
            padding: 1rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .text-white {
            color: white;
        }

        .text-red-500 {
            color: #ef4444;
        }

        .text-green-500 {
            color: #22c55e;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .font-bold {
            font-weight: bold;
        }

        .font-semibold {
            font-weight: 600;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }
    </style>
{% endblock %}
